<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Jeu</title>
    <meta name="description" content="Page du jeu." />
    <link rel="stylesheet" href="./styles.css" />
</head>

<body>
    <img id="SantaImage" src="./Assets/santa.png" alt="Père Noël" />
    <img id="displayImage" src="./Assets/Rectangle 1.png" alt="sol" />

    <div class="status-bar">
        <span id="selectedPerson"></span>
        <span id="result"></span>
    </div>

    <div class="grid" id="grid"></div>

    <button id="actionButton">
        Jouer
    </button>

    <!-- Modale de confirmation -->
    <div id="modal" class="modal-overlay" hidden>
        <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
            <h2 id="modalTitle">Ton super kdo</h2>
            <img id="modalImage" alt="Sélection" />
            <div class="modal-actions">
                <button id="acceptBtn" class="modal-btn accept">Accepter</button>
                <button id="declineBtn" class="modal-btn decline">Refuser</button>
            </div>
        </div>
    </div>

    <!-- Modale de résultat -->
    <div id="resultModal" class="modal-overlay" hidden>
        <div class="modal-content resultModal" role="dialog" aria-modal="true" aria-labelledby="resultTitle">
            <h2 id="resultTitle">Ton super kdo</h2>
            <div class="result-body">
                <img id="resultImage" alt="Résultat" />
                <div id="resultDialog" class="dialog dialogGauche">
                    <p id="resultMessage"></p>
                </div>
            </div>
            <div class="modal-actions">
                <button id="closeResultBtn" class="modal-btn decline">Fermer</button>
            </div>
        </div>
    </div>

    <script>
        // Récupère le paramètre "person" et l'affiche si présent
        const params = new URLSearchParams(window.location.search);
        const person = params.get('person');

        // Items de grille selon la personne sélectionnée
        function getGridItemsForPerson(p) {
            const key = (p || '').toLowerCase();
            switch (key) {
                                case 'papa':
                    return [
                        { nom: 'Reverse', image: './Assets/imageKDO/reverse.png', chance: 0.10, kDoB1:false, message: "Revers c'est à toi de m'offrir un cadeau maintenant" },//
                        { nom: 'calendrier chien caca', image: './Assets/imageKDO/calendrier chien caca.avif', chance: 0.15, kDoB1:false, message: "Ces paysages ne sont-ils pas magnifiques ?" },//
                        { nom: 'iphon 3gs', image: './Assets/imageKDO/iphon 3gs.avif', chance: 0.10, kDoB1:false, message:'Tu vas pouvoir réparer ton ancien iPhone. ah tu n\'en as pas?'  },//
                        { nom: '20e', image: './Assets/imageKDO/20e.png', chance: 0.10, kDoB1:true, message: "Tiens 20 balles en espèces tu pourras t'acheter des bonbecs à la boulange" },//
                        { nom: 'douche spider', image: './Assets/imageKDO/douche spider.jpg', chance: 0.10, kDoB1:false, message:'Tiens c\'est un petit doudouche sur Spyder'  },//
                        { nom: 'cinture', image: './Assets/imageKDO/cinture.jpg', chance: 0.10, kDoB1:true, message: "Une ceinture pour tenir tes pantalons et tes outils" },//
                        { nom: 'casio', image: './Assets/imageKDO/casio.jpg', chance: 0.10, kDoB1:true, message: "Une montre pour ne jamais être en retard" },//
                        { nom: 'casquet', image: './Assets/imageKDO/casquet.avif', chance: 0.10,  kDoB1:false, message: 'Une méga casquette pour le maxi soleil' },//
                        { nom: 'frigo m', image: './Assets/imageKDO/frigo m.avif', chance: 0.10,  kDoB1:false , message: 'Heuu j\'ai pas d\'idée'},//
                    ];
                case 'maman':
                    return [
                        { nom: 'miroir', image: './Assets/imageKDO/miroir.jpg', chance: 0.10, kDoB1:true, message: "Miroir miroir tu connais la suite" },//
                        { nom: 'chat lego', image: './Assets/imageKDO/chatLego.avif', chance: 0.15, kDoB1:false, message:'Tiens un petit chat Lego amuse-toi'  },//
                        { nom: 'Reverse', image: './Assets/imageKDO/reverse.png', chance: 0.10, kDoB1:false, message: "Revers c'est à toi de m'offrir un cadeau maintenant" },//
                        { nom: 'frigo m', image: './Assets/imageKDO/frigo m.avif', chance: 0.10, kDoB1:false , message: 'Nouveau frigo ?'},//
                        { nom: 'gourde Cafe', image: './Assets/imageKDO/gourdecafe.jpg', chance: 0.10, kDoB1:true, message: "Une gourde pour ton café" },//
                        { nom: 'chien clef', image: './Assets/imageKDO/chien clef.avif', chance: 0.10, kDoB1:false, message: "Un porte-clé chien trop mignon" },//
                        { nom: 'gourde', image: './Assets/imageKDO/gourde.jpg', chance: 0.10, kDoB1:true, message: "Une gourde pour rester hydraté" },//
                        { nom: '20e', image: './Assets/imageKDO/20e.png', chance: 0.10, kDoB1:true, message: "Tiens 20 balles en espèces tu pourras t'acheter des bonbecs à la boulange" },//
                        { nom: 'iphon 3gs', image: './Assets/imageKDO/iphon 3gs.avif', chance: 0.10,  kDoB1:false, message:'Tu vas pouvoir réparer ton ancien iPhone. ah tu n\'en as pas?'  },//
                    ];
                default:
                    return [
                        { nom: '1kdo', image: './Assets/1kdo 2.png', chance: 0.05 },
                        { nom: 'BG', image: './Assets/BG 1KDO 2.png', chance: 0.10 },
                        { nom: 'chad', image: './Assets/gigachad.png', chance: 0.15 },
                        { nom: 'cadeau', image: './Assets/kado.png', chance: 0.05 },
                        { nom: 'lampe', image: './Assets/lampadaire.png', chance: 0.20 },
                        { nom: 'pn', image: './Assets/petitcacanoel.png', chance: 0.10 },
                        { nom: 'sol', image: './Assets/Rectangle 1.png', chance: 0.10 },
                        { nom: 'santa', image: './Assets/santa.png', chance: 0.15 },
                        { nom: 'sapin', image: './Assets/sapin.png', chance: 0.10 },
                    ];
            }
        }
        let gridItems = getGridItemsForPerson(person);

        const gridEl = document.getElementById('grid');
        const resultEl = document.getElementById('result');
        const playBtn = document.getElementById('actionButton');
        const selectedPersonEl = document.getElementById('selectedPerson');
        
        const modalEl = document.getElementById('modal');
        const modalImageEl = document.getElementById('modalImage');
        const acceptBtn = document.getElementById('acceptBtn');
        const declineBtn = document.getElementById('declineBtn');

        // Deuxième modale (résultat)
        const resultModalEl = document.getElementById('resultModal');
        const resultImageEl = document.getElementById('resultImage');
        const resultDialogEl = document.getElementById('resultDialog');
        const resultMessageEl = document.getElementById('resultMessage');
        const closeResultBtn = document.getElementById('closeResultBtn');

        // Génère/régénère la grille 3×3
        let cells = [];
        function renderGrid() {
            gridEl.innerHTML = '';
            cells = [];
            gridItems.forEach((item, idx) => {
                const cell = document.createElement('div');
                cell.className = 'cell';
                cell.dataset.index = String(idx);
                const img = document.createElement('img');
                img.src = item.image;
                img.alt = item.nom;
                cell.appendChild(img);
                gridEl.appendChild(cell);
                // Ouvre la modale quand une case est sélectionnée manuellement
                cell.addEventListener('click', () => {
                    if (spinning) return;
                    selectCell(idx);
                    openModal(idx);
                });
                cells.push(cell);
            });
        }
        renderGrid();

        // Tirage pondéré par la propriété "chance"
        function weightedRandomIndex(items) {
            const total = items.reduce((sum, it) => sum + (it.chance || 0), 0);
            const r = Math.random() * total;
            let acc = 0;
            for (let i = 0; i < items.length; i++) {
                acc += (items[i].chance || 0);
                if (r < acc) return i;
            }
            return items.length - 1; // fallback si arrondi flottant
        }

        // Sélection et feedback visuel
        let currentIndex = null;
        function selectCell(index) {
            cells.forEach(c => c.classList.remove('selected'));
            const chosen = cells[index];
            if (chosen) {
                chosen.classList.add('selected');
                currentIndex = index;
            }
        }

        // Animation de roulette: les cases s'allument à tour de rôle puis s'arrêtent sur la bonne
        let spinning = false;
        function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

        function setActive(index) {
            cells.forEach(c => c.classList.remove('active'));
            const el = cells[index];
            if (el) el.classList.add('active');
        }

        async function spinTo(index, cycles = 3) {
            const totalSteps = cycles * cells.length + index; // termine exactement sur l'index visé
            let step = 0;
            let activeIdx = -1;
            let interval = 120; // vitesse de départ

            while (step < totalSteps) {
                activeIdx = (activeIdx + 1) % cells.length;
                setActive(activeIdx);
                step++;

                const remaining = totalSteps - step;
                // ralentit vers la fin pour l'effet suspense
                if (remaining <= 6) interval = 300;
                else if (remaining <= 12) interval = 200;

                await sleep(interval);
            }

            // Fin: enlève l'état actif et sélectionne la case gagnante
            cells.forEach(c => c.classList.remove('active'));
            selectCell(index);
            openModal(index);
        }

        function openModal(index) {
            const item = gridItems[index];
            if (!item) return;
            modalImageEl.src = item.image;
            modalImageEl.alt = item.nom;
            modalEl.hidden = false;
        }

        function closeModal() {
            modalEl.hidden = true;
        }

        function openResultModal(forItem) {
            // Choix de l'image et orientation du dialogue selon kDoB1
            const isGood = !!forItem?.kDoB1;
            const imgPath = isGood ? './Assets/gigachad.png' : './Assets/petitcacanoel.png';
            const message = forItem?.message || (isGood ? 'Bravo !' : 'Oups...');

            resultImageEl.src = imgPath;
            resultImageEl.alt = isGood ? 'Gigachad' : 'Petit Caca Noël';

            resultMessageEl.textContent = message;

            // Positionne la bulle de dialogue
            resultDialogEl.classList.remove('dialogGauche', 'dialogDroit');
            resultDialogEl.classList.add(isGood ? 'dialogGauche' : 'dialogDroit');

            resultModalEl.hidden = false;
        }

        function closeResultModal() {
            resultModalEl.hidden = true;
        }

        acceptBtn.addEventListener('click', () => {
            const item = gridItems[currentIndex];
            closeModal();
            openResultModal(item);
        });

        declineBtn.addEventListener('click', () => {
            closeModal();
        });

        // Fermeture de la modale résultat
        closeResultBtn.addEventListener('click', () => {
            closeResultModal();
        });
        // Clique en dehors (overlay) pour fermer la modale résultat
        resultModalEl.addEventListener('click', (e) => {
            if (e.target === resultModalEl) closeResultModal();
        });

        // Au clic sur "Jouer": spin pondéré sans décompte
        playBtn.addEventListener('click', async () => {
            if (spinning) return;
            spinning = true;

            resultEl.textContent = '';
            // ferme la modale si elle est ouverte
            try { modalEl.hidden = true; } catch (e) {}
            cells.forEach(c => c.classList.remove('selected', 'active'));

            const idx = weightedRandomIndex(gridItems);
            await spinTo(idx, 3);

            spinning = false;
        });

        // Animation de secousse aléatoire toutes les 7s
        const SHAKE_INTERVAL_MS = 7000; // 7 secondes
        const SHAKE_DURATION_MS = 800;   // doit correspondre à l'animation CSS

        function triggerRandomCellShake() {
            if (!cells || cells.length === 0) return;
            if (spinning) return; // évite de perturber l'animation de roulette

            const index = Math.floor(Math.random() * cells.length);
            const el = cells[index];
            if (!el) return;

            // Si déjà en train de secouer, on ignore pour éviter l'empilement
            if (el.classList.contains('shake')) return;

            el.classList.add('shake');
            setTimeout(() => {
                el.classList.remove('shake');
            }, SHAKE_DURATION_MS);
        }

        // Démarre l'intervalle de secousse après le rendu de la grille
        setInterval(triggerRandomCellShake, SHAKE_INTERVAL_MS);
    </script>
</body>

</html>